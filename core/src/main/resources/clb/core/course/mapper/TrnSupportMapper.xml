<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="clb.core.course.mapper.TrnSupportMapper">
    <resultMap id="BaseResultMap" type="clb.core.course.dto.TrnSupport">
        <result column="SUPPORT_ID" property="supportId" jdbcType="DECIMAL" />
        <result column="SUPPORT_NUM" property="supportNum" jdbcType="VARCHAR" />
        <result column="CHANNEL_ID" property="channelId" jdbcType="DECIMAL" />
        <result column="CHANNEL_NAME" property="channelName" jdbcType="VARCHAR" />
        <result column="SUPPORT_TYPE" property="supportType" jdbcType="VARCHAR" />
        <result column="CREATER_NAME" property="createrName" jdbcType="VARCHAR" />
        <result column="PHONE_CODE" property="phoneCode" jdbcType="VARCHAR" />
        <result column="CONTACT_PHONE_COMB" property="contactPhoneComb" jdbcType="VARCHAR" />
        <result column="CONTACT_PHONE" property="contactPhone" jdbcType="VARCHAR" />
        <result column="CONTACT_EMAIL" property="contactEmail" jdbcType="VARCHAR" />
        <result column="AMOUNT" property="amount" jdbcType="DECIMAL" />
        <result column="STATUS" property="status" jdbcType="VARCHAR" />
        <result column="TRAIN_CONTENT" property="trainContent" jdbcType="VARCHAR" />
        <result column="TRAIN_MAIN_TYPE" property="trainMainType" jdbcType="VARCHAR" />
        <result column="TRAIN_PEOPLE_NUM" property="trainPeopleNum" jdbcType="VARCHAR" />
        <result column="TRAIN_START_DATE" property="trainStartDate" jdbcType="TIMESTAMP" />
        <result column="TRAIN_END_DATE" property="trainEndDate" jdbcType="TIMESTAMP" />
        <result column="TRAIN_TEACHER" property="trainTeacher" jdbcType="VARCHAR" />
        <result column="train_other" property="trainOther" />
        <result column="TRAIN_ADDRESS" property="trainAddress" jdbcType="VARCHAR" />
        <result column="COST_TOPIC" property="costTopic" jdbcType="VARCHAR" />
        <result column="cost_par_type" property="costParType" />
        <result column="cost_par_total" property="costParTotal" />
        <result column="COST_START_DATE" property="costStartDate" jdbcType="TIMESTAMP" />
        <result column="COST_END_DATE" property="costEndDate" jdbcType="TIMESTAMP" />
        <result column="PROVINCE" property="province" jdbcType="VARCHAR" />
        <result column="CITY" property="city" jdbcType="VARCHAR" />
        <result column="COST_ADDRESS" property="costAddress" jdbcType="VARCHAR" />
        <result column="COST_TEACHER" property="costTeacher" jdbcType="VARCHAR" />
        <result column="COST_TARGET" property="costTarget" jdbcType="VARCHAR" />
        <result column="OTHER" property="other" jdbcType="VARCHAR" />
        <result column="COST_CONTENT" property="costContent" jdbcType="VARCHAR" />
        <result column="GUEST_DATE" property="guestDate" jdbcType="TIMESTAMP" />
        <result column="GUEST_END_DATE" property="guestEndDate" jdbcType="TIMESTAMP" />
        <result column="GUEST_ADDRESS" property="guestAddress" jdbcType="VARCHAR" />
        <result column="GUEST_TEACHER" property="guestTeacher" jdbcType="VARCHAR" />
        <result column="GUEST_BACKGROUND" property="guestBackground" jdbcType="VARCHAR" />
        <result column="guest_other" property="guestOther" />
        <result column="GUEST_PAR_TOTAL" property="guestParTotal" />
        <result column="GUEST_DISCUSS_CONTENT" property="guestDiscussContent" />
        <result column="GUEST_PERCENT" property="guestPercent" />
        <result column="PROVINCE_MEANING" property="provinceMeaning" jdbcType="VARCHAR" />
        <result column="CITY_MEANING" property="cityMeaning" jdbcType="VARCHAR" />
        <result column="PROGRAM_ID" property="programId" jdbcType="DECIMAL" />
        <result column="REQUEST_ID" property="requestId" jdbcType="DECIMAL" />
        <result column="AREA" property="area" jdbcType="VARCHAR" />
        <result column="CREATION_DATE" property="submitDate" jdbcType="TIMESTAMP" />
        <result column="AMOUNT_OPERATION_DATE" property="amountOperationDate" jdbcType="TIMESTAMP" />
    </resultMap>
    
    <resultMap id="AllFieldsMap" type="clb.core.course.dto.TrnSupport">
        <result column="SUPPORT_ID" property="supportId" jdbcType="DECIMAL" />
        <result column="SUPPORT_NUM" property="supportNum" jdbcType="VARCHAR" />
        <result column="CHANNEL_ID" property="channelId" jdbcType="DECIMAL" />
        <result column="CHANNEL_NAME" property="channelName" jdbcType="VARCHAR" />
        <result column="SUPPORT_TYPE" property="supportType" jdbcType="VARCHAR" />
        <result column="CREATER_NAME" property="createrName" jdbcType="VARCHAR" />
        <result column="PHONE_CODE" property="phoneCode" jdbcType="VARCHAR" />
        <result column="CONTACT_PHONE_COMB" property="contactPhoneComb" jdbcType="VARCHAR" />
        <result column="CONTACT_PHONE" property="contactPhone" jdbcType="VARCHAR" />
        <result column="CONTACT_EMAIL" property="contactEmail" jdbcType="VARCHAR" />
        <result column="AMOUNT" property="amount" jdbcType="DECIMAL" />
        <result column="STATUS" property="status" jdbcType="VARCHAR" />
        <result column="TRAIN_CONTENT" property="trainContent" jdbcType="VARCHAR" />
        <result column="TRAIN_MAIN_TYPE" property="trainMainType" jdbcType="VARCHAR" />
        <result column="TRAIN_PEOPLE_NUM" property="trainPeopleNum" jdbcType="VARCHAR" />
        <result column="TRAIN_START_DATE" property="trainStartDate" jdbcType="TIMESTAMP" />
        <result column="TRAIN_END_DATE" property="trainEndDate" jdbcType="TIMESTAMP" />
        <result column="TRAIN_TEACHER" property="trainTeacher" jdbcType="VARCHAR" />
        <result column="train_other" property="trainOther" />
        <result column="TRAIN_ADDRESS" property="trainAddress" jdbcType="VARCHAR" />
        <result column="COST_TOPIC" property="costTopic" jdbcType="VARCHAR" />
        <result column="cost_par_type" property="costParType" />
        <result column="cost_par_total" property="costParTotal" />
        <result column="COST_START_DATE" property="costStartDate" jdbcType="TIMESTAMP" />
        <result column="COST_END_DATE" property="costEndDate" jdbcType="TIMESTAMP" />
        <result column="PROVINCE" property="province" jdbcType="VARCHAR" />
        <result column="CITY" property="city" jdbcType="VARCHAR" />
        <result column="COST_ADDRESS" property="costAddress" jdbcType="VARCHAR" />
        <result column="COST_TEACHER" property="costTeacher" jdbcType="VARCHAR" />
        <result column="COST_TARGET" property="costTarget" jdbcType="VARCHAR" />
        <result column="OTHER" property="other" jdbcType="VARCHAR" />
        <result column="COST_CONTENT" property="costContent" jdbcType="VARCHAR" />
        <result column="GUEST_DATE" property="guestDate" jdbcType="TIMESTAMP" />
        <result column="GUEST_END_DATE" property="guestEndDate" jdbcType="TIMESTAMP" />
        <result column="GUEST_ADDRESS" property="guestAddress" jdbcType="VARCHAR" />
        <result column="GUEST_TEACHER" property="guestTeacher" jdbcType="VARCHAR" />
        <result column="GUEST_BACKGROUND" property="guestBackground" jdbcType="VARCHAR" />
        <result column="guest_other" property="guestOther" />
        <result column="GUEST_PAR_TOTAL" property="guestParTotal" />
        <result column="GUEST_DISCUSS_CONTENT" property="guestDiscussContent" />
        <result column="GUEST_PERCENT" property="guestPercent" />
        <result column="PROVINCE_MEANING" property="provinceMeaning" jdbcType="VARCHAR" />
        <result column="CITY_MEANING" property="cityMeaning" jdbcType="VARCHAR" />
        <result column="PROGRAM_ID" property="programId" jdbcType="DECIMAL" />
        <result column="REQUEST_ID" property="requestId" jdbcType="DECIMAL" />
        <result column="AREA" property="area" jdbcType="VARCHAR" />
        <result column="CREATION_DATE" property="submitDate" jdbcType="TIMESTAMP" />
        <result column="AMOUNT_OPERATION_DATE" property="amountOperationDate" jdbcType="TIMESTAMP" />
    </resultMap>
	
	<select id="updateAmountInvalid" parameterType="clb.core.course.dto.TrnSupport" resultMap="AllFieldsMap" >
        SELECT fts.*
        FROM fms_trn_support fts
        WHERE AMOUNT IS NOT NULL
        AND STATUS = "PAYMENT"
    </select>
	
	<select id="selectAllField" parameterType="clb.core.course.dto.TrnSupport" resultMap="AllFieldsMap">
		SELECT
		fts.SUPPORT_ID,
		fts.SUPPORT_NUM,
		fts.CHANNEL_ID,
		c.CHANNEL_NAME,
		fts.SUPPORT_TYPE,
		fts.CREATER_NAME,
		fts.PHONE_CODE,
		fts.CONTACT_PHONE,
		fts.CONTACT_EMAIL,
		fts.AMOUNT,
		fts.STATUS,
		fts.TRAIN_CONTENT,
		fts.TRAIN_MAIN_TYPE,
		fts.TRAIN_PEOPLE_NUM,
		fts.TRAIN_START_DATE,
		fts.TRAIN_END_DATE,
		fts.TRAIN_TEACHER,
		fts.train_other,
		fts.TRAIN_ADDRESS,
		fts.COST_TOPIC,
		fts.cost_par_type,
		fts.cost_par_total,
		fts.COST_START_DATE,
		fts.COST_END_DATE,
		fts.PROVINCE,
		fts.CITY,
		fts.COST_ADDRESS,
		fts.COST_TEACHER,
		fts.COST_TARGET,
		fts.OTHER,
		fts.COST_CONTENT,
		fts.GUEST_DATE,
		fts.GUEST_END_DATE,
		fts.GUEST_ADDRESS,
		fts.GUEST_TEACHER,
		fts.GUEST_BACKGROUND,
		fts.GUEST_PAR_TOTAL,
		fts.guest_other,
        fts.GUEST_DISCUSS_CONTENT,
        fts.GUEST_PERCENT ,
		fts.CREATION_DATE,
		fts.AMOUNT_OPERATION_DATE,
        (CASE WHEN SUPPORT_TYPE = 'TRAIN' THEN TRAIN_START_DATE WHEN SUPPORT_TYPE = 'COST' THEN COST_START_DATE  ELSE GUEST_DATE END) startFrom,
        (CASE WHEN SUPPORT_TYPE = 'TRAIN' THEN TRAIN_END_DATE WHEN SUPPORT_TYPE = 'COST' THEN COST_END_DATE ELSE GUEST_END_DATE END) startTo,
		scvt.meaning PROVINCE_MEANING,
        scvt1.meaning CITY_MEANING,
		CONCAT(scvt.meaning,scvt1.meaning) AREA
		FROM fms_trn_support_v fts 
		LEFT JOIN fms_cnl_channel c 
		ON c.CHANNEL_ID=fts.CHANNEL_ID
		LEFT JOIN sys_code_b sc
        ON SC.code = 'PUB.PROVICE'
        LEFT JOIN sys_code_value_b scvb
        ON scvb.code_id=sc.code_id
        AND scvb.value=fts.PROVINCE
        LEFT JOIN sys_code_value_tl scvt
        ON scvt.code_value_id=scvb.code_value_id
        AND scvt.lang = #{request.locale, jdbcType = VARCHAR}
        LEFT JOIN sys_code_b sc1
        ON SC1.code = 'PUB.CITY'
        LEFT JOIN sys_code_value_b scvb1
        ON scvb1.code_id=sc1.code_id
        AND scvb1.value=fts.CITY
        LEFT JOIN sys_code_value_tl scvt1
        ON scvt1.code_value_id=scvb1.code_value_id
        AND scvt1.lang = #{request.locale, jdbcType = VARCHAR}
		WHERE 1=1
		<if test="supportId!=null and supportId!=''">
			and fts.SUPPORT_ID =#{supportId}
		</if>
		<if test="trainTeacher!=null and trainTeacher!=''">
			and fts.TRAIN_TEACHER =#{trainTeacher}
		</if>
		
		<if test = "area != null"> AND CONCAT(scvt.meaning,scvt1.meaning) = #{area , jdbcType=VARCHAR} </if>
        <if test = "province != null"> AND fts.PROVINCE = #{province , jdbcType=VARCHAR} </if>
        <if test = "city != null"> AND fts.CITY = #{city , jdbcType=VARCHAR} </if>
		
		<if test="startDate!=null and startDate!=''">
		 	and fts.TRAIN_START_DATE &gt;=#{startDate}  
		</if>
		
		<if test="endDate!=null and endDate!=''">
			and fts.TRAIN_END_DATE &lt;=#{endDate}  
		</if>
		
		
		<if test="supportNum!=null and supportNum!=''">
			and fts.SUPPORT_NUM like CONCAT('%', #{supportNum}, '%')
		</if>
		
		<if test="channelId!=null">
			and fts.CHANNEL_ID = #{channelId}
		</if>
		
		<if test="channelName!=null and channelName!=''">
			and c.CHANNEL_NAME like CONCAT('%', #{channelName}, '%')
		</if>
		
		<if test="supportType!=null and supportType!=''">
			and fts.SUPPORT_TYPE =#{supportType}
		</if>
		<if test="status!=null and status!=''">
			and fts.STATUS =#{status}
		</if>
		<if test="contactPhone!=null and contactPhone!=''">
			and fts.CONTACT_PHONE like CONCAT('%', #{contactPhone}, '%')
		</if>
		<if test = "contactPhoneComb != null"> AND CONCAT(fts.PHONE_CODE,' ',fts.CONTACT_PHONE) like CONCAT('%', #{contactPhoneComb}, '%')</if>
		ORDER BY fts.order_num , fts.CREATION_DATE DESC
	</select>

    <select id="supportQueryTotal" parameterType="clb.core.course.dto.TrnSupport"
            resultType="java.lang.Long">
        SELECT
        COUNT(*)
        FROM fms_trn_support_v fts
        WHERE 1=1
        <if test="channelId!=null">
            and fts.CHANNEL_ID = #{channelId}
        </if>
        <if test="status!=null and status!=''">
            and fts.STATUS =#{status}
        </if>
    </select>

</mapper>