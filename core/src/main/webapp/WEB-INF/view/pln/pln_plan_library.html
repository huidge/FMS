<#include "../include/header.html">
<script src="${base.contextPath}/clb/common/clbCode?gender=HR.EMPLOYEE_GENDER" type="text/javascript"></script>
<script src="${base.contextPath}/clb/common/clbCode?flag=SYS.YES_NO" type="text/javascript"></script>
<script src="${base.contextPath}/clb/common/clbCode?payMethodData=CMN.PAY_METHOD" type="text/javascript"></script>
<script src="${base.contextPath}/clb/common/clbCode?nationality=PUB.NATION" type="text/javascript"></script>
<script src="${base.contextPath}/clb/common/clbCode?city=PUB.CITY" type="text/javascript"></script>
<script src="${base.contextPath}/clb/common/clbCode?age=PLN_AGE" type="text/javascript"></script>
<script src="${base.contextPath}/clb/common/clbCode?currency=PUB.CURRENCY" type="text/javascript"></script>
<script type="text/javascript">
    var securityArea;
    var securityLevel;
    var viewModel = kendo.observable({
        model: {},
        genderCom  :  gender,
        flagCom : flag,
        payMethodCom : payMethodData,
        nationalityCom : nationality,
        cityCom:city,
        ageCom:age,
        securityArea:securityArea,
        securityLevel:securityLevel,
        createFunction: function () {
            $('#grid').data('kendoGrid').addRow();
        },
        saveFunction: function () {
            $('#grid').data('kendoGrid').saveChanges();
        },
        queryFunction: function (e) {
            $('#grid').data('kendoGrid').dataSource.page(1);
        },
        resetForm : function(e) {
            var formData = viewModel.model.toJSON();
            for ( var k in formData) {
                viewModel.model.set(k, null);
            }
       }
    });
</script>
<body>
<script type="text/javascript">
//新增一条记录
function newData() {
    $('#grid').data('kendoGrid').addRow();
}

//保存
function saveData(){
	var grid = $('#grid').data('kendoGrid');
	var data = $('#grid').data('kendoGrid').dataItems();
	//当产品为高端医疗时，除城市字段外，其他均为必填项，需填写才可保存
	for(var j=0;j<data.length;j++){
		if(data[j].dirty == true){
			if(data[j].minClass =="GD" ){
				if(data[j].selfpay == null || data[j].selfpay == ""){
					kendo.ui.showErrorDialog({
			            title:$l('hap.tip.info'),
			            message:'高端医疗产品自付选项必填!'
			        });
					return;
				}
				if(data[j].securityArea == null || data[j].securityArea == ""){
					kendo.ui.showErrorDialog({
			            title:$l('hap.tip.info'),
			            message:'高端医疗产品保障区域必填!'
			        });
					return;
				}
				if(data[j].securityLevel == null || data[j].securityLevel == ""){
					kendo.ui.showErrorDialog({
			            title:$l('hap.tip.info'),
			            message:'高端医疗产品保障级别必填!'
			        });
					return;
				}
			}
			//产品类型为万用寿险，除保障级别/保障地区/字符选项外，其他均为必填项，需填写才可保存
			if(data[j].midClass =="WYSX" ){
				if(data[j].city == null || data[j].city == ""){
					kendo.ui.showErrorDialog({
			            title:$l('hap.tip.info'),
			            message:'万用寿险产品城市必填!'
			        });
					return;
				}
			}
		}
	}
	
    $('#grid').data('kendoGrid').saveChanges();
}

//公司维护文件下载
function downloadFileCompany(uid)
{
    data =  $('#grid').data('kendoGrid').dataSource.getByUid(uid);
    $.ajax({
        url : '${base.contextPath}/commons/attach/validateFile',
        type : "POST",
        dataType : "json",
        data : {
            fileId:data.fileId,
            token:data._token
        },
        success : function(json) {
            if(json.success == true){
                url='${base.contextPath}/sys/attach/file/detail?fileId='+data.fileId+'&token='+data._token;
                var iframe = document.getElementById("ifileCompany");
                iframe.src=url;
            }else{
                kendo.ui.showErrorDialog({
                    message  : '<@spring.message "fms.file_not_exists"/>'
                })
            }
        },
    })

};

$(document).ready(function () {
    var BaseUrl = _basePath;
    dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/fms/pln/plan/library/query",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/fms/pln/plan/library/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/fms/pln/plan/library/remove",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/fms/pln/plan/library/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "libraryId",
                fields: {
                	  gender: {validation: { required: true }},
                      smokeFlag: {validation: { required: true }},
                      payMethod:{validation: { required: true }},
                      nationality:{validation: { required: true }},
                      currency:{validation: { required: true }},
                      residence:{validation: { required: true }},
                      city:{},
                      securityArea:{},
                      securityLevel:{},
                }
            }
        }
    });

    $("#grid").kendoGrid({
        dataSource: dataSource,
        height: '100%',
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable: 'multiple, rowbox',
        toolbar: [
                  {
                      template: '<button type="button"  onclick="newData()" class="btn btn-primary">' +
                      '<i class="fa fa-plus-square" style="margin-right:3px;"></i><@spring.message "hap.new"/></button>'
                  },
                  {
                      name: "save",
                      template: '<span class="btn btn-success" onclick="saveData()">' +
                      '<i class="fa fa-save" style="margin-right:3px;"></i><@spring.message "hap.save"/></span>'
                  },
                  {
                      name: "cancel",
                      template: '<span class="btn btn-default k-grid-cancel-changes">' +
                      '<i class="fa fa-eraser" style="margin-right:3px;"></i><@spring.message "hap.cancel"/></span>'
                  }
              ],
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
//             {
// 	            title: '下载',
//                 width: 120,
//                 headerAttributes: {
//                    style: "text-align:center"
//                 },
//                 attributes: {
//                    style: "text-align:center"
//                 },
//                 template: function (item) {
//                    return '<a href="#" onClick="downloadFileCompany(\''+item.uid+'\')">下载</a>';
//                 }
//             },           
            {
                field: "itemName",
                title: "产品名称",
                width: 120,
                editor : function(container, options){
	            	$('<input required data-required-msg="必输" name="' + options.field + '"/>').appendTo(container).kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "PRD_ITEMS")}, 
                    	{
                    	model: options.model,
                    	textField: 'itemName',
                    	select : function(e){
                    		options.model.set('itemCode', e.item.itemCode);
                    		options.model.set('itemName', e.item.itemName);
                    		options.model.set('itemId', e.item.itemId);
                    		options.model.set('minClass', e.item.minClass);
                    		options.model.set('midClass', e.item.midClass);
                    		options.model.set('bigClass', e.item.bigClass);
                    		options.model.set('selfpay', "");
                    		options.model.set('securityArea', "");
                    		options.model.set('securityLevel', "");
                    		options.model.set('currency', "");
                    		options.model.set('sublineItemName', "");
                    		options.model.set('payMethod', "");
                    		options.model.set('city', "");
                    	}
                    }))
	            },
            },
            {
                field: "currency",
                title: "币种",
                width: 120,
                template: function(dataItem){
                    var v = dataItem.currency;
                    $.each(currency,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    })
                    return v;
                 },
                 editor: function(container, options){
                	//币种查询
                     $.ajax({
                         type:"POST",
                         async:false,
                         url:"${base.contextPath}/fms/pln/plan/library/queryCurrencyByItem",
                         data:{"itemId":options.model.itemId,"code":"PUB.CURRENCY"},
                         dataType : 'json',
                         success: function(e) {
                             $('<input name="' + options.field + '" data-bind="value:currency" />')
                                 .appendTo(container)
                                 .kendoDropDownList({
                                     dataTextField: "meaning",
                                     dataValueField: "value",
                                     dataSource: e.rows,
                                     optionLabel:"--请选择--",
                                     change : function(e) {
                                     }
                                 });
                         }
                     });
                	 
                 } 
            },
            {
                field: "sublineItemName",
                title: "年期",
                width: 120,
                editor: function (container, options) {
                    $('<input  required data-required-msg="必输" name="' + options.field + '"/>')
                            .appendTo(container)
                            .kendoLov($.extend(<@lov "ORD_SUBLINE"/>, 
                           {
                                textField: 'sublineItemName',
                                model    : options.model,
                                select:function(e){
				                	options.model.set('sublineItemName', e.item.sublineItemName);
				                	options.model.set('sublineId', e.item.sublineId);
				                }
                            },
                            {
                            	query: function (e) {
                                   e.param['itemId'] = options.model.itemId;
                                 }
                            }));
                }
            },
            {
                field: "payMethod",
                title: "缴费方式",
                width: 120,
                template: function(dataItem){
                    var v = dataItem.payMethod;
                    $.each(payMethodData,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    })
                    return v;
                 },
                 editor: function(container, options){
                	 
                	//缴费方式
                     $.ajax({
                         type:"POST",
                         async:false,
                         url:"${base.contextPath}/fms/pln/plan/library/queryPaymethodByItem",
                         data:{"itemId":options.model.itemId},
                         dataType : 'json',
                         success: function(e) {
                             $('<input name="' + options.field + '" data-bind="value:payMethod" />')
                                 .appendTo(container)
                                 .kendoDropDownList({
                                     dataTextField: "meaning",
                                     dataValueField: "value",
                                     dataSource: e.rows,
                                     optionLabel:"--请选择--",
                                     change : function(e) {
                                     }
                                 });
                         }
                     });
                 }
            },
            {
                field: "age",
                title: "年龄",
                width: 120
            },
            {
                field: "gender",
                title: "性别",
                width: 120,
                template: function(dataItem){
                    var v = dataItem.gender;
                    $.each(gender,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    })
                    return v;
                 },
                 editor: function(container, options){
                     $('<input required data-required-msg="必输" name="' + options.field + '"/>')
                     .appendTo(container)
                     .kendoDropDownList({
                         dataTextField: "meaning",
                         dataValueField: "value",
                         dataSource: gender
                     });
                 } 
            },
            {
                field: "smokeFlag",
                title: "是否吸烟",
                width: 120,
                template: function(dataItem){
                    var v = dataItem.smokeFlag;
                    $.each(flag,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    })
                    return v;
                 },
                 editor: function(container, options){
                     $('<input required data-required-msg="必输" name="' + options.field + '"/>')
                     .appendTo(container)
                     .kendoDropDownList({
                         dataTextField: "meaning",
                         dataValueField: "value",
                         dataSource: flag
                     });
                 } 
            },
            {
                field: "nationality",
                title: "国籍",
                width: 120,
                template: function(dataItem){
                    var v = dataItem.nationality;
                    $.each(nationality,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    })
                    return v;
                 },
                 editor: function(container, options){
                     $('<input required data-required-msg="必输" name="' + options.field + '"/>')
                     .appendTo(container)
                     .kendoDropDownList({
                         dataTextField: "meaning",
                         dataValueField: "value",
                         optionLabel:"--请选择--",
                         dataSource: nationality
                     });
                 } 
            },
            {
                field: "residence",
                title: "居住地",
                width: 120,
                template: function(dataItem){
                    var v = dataItem.residence;
                    $.each(nationality,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    })
                    return v;
                 },
                 editor: function(container, options){
                     $('<input required data-required-msg="必输" name="' + options.field + '"/>')
                     .appendTo(container)
                     .kendoDropDownList({
                         dataTextField: "meaning",
                         dataValueField: "value",
                         optionLabel:"--请选择--",
                         dataSource: nationality
                     });
                 } 
            },
            {
                field: "city",
                title: "城市",
                width: 120,
                template: function(dataItem){
                    var v = dataItem.city;
                    $.each(city,function(i,n){
                        if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.meaning;
                            return v;
                        }
                    });
                    if(v == null || typeof(v)=="undefined" || v == "undefined"){
                    	return '';
                    }
                    
                    return v;
                 },
                 editor: function(container, options){
                     $('<input name="' + options.field + '"/>')
                     .appendTo(container)
                     .kendoDropDownList({
                         dataTextField: "meaning",
                         dataValueField: "value",
                         optionLabel:"--请选择--",
                         dataSource: city
                     });
                     
                     if(options.model.midClass != 'WYSX'){
                     	$("input[name='city']").data("kendoDropDownList").enable(false);
                     }
                 } 
            },
            {
                field: "amount",
                title: "保额",
                width: 120,
                editor: function (container, options) {
               	 $('<input name="' + options.field + '"/>')
                            .appendTo(container)
                            .kendoNumericTextBox({
                           	 decimals: 0,
                                min: 0,
                                step:1
                            });
                }
            },
            {
                field: "premium",
                title: "保费",
                width: 120,
                editor: function (container, options) {
               	 $('<input  name="' + options.field + '"/>')
                            .appendTo(container)
                            .kendoNumericTextBox({
                           	 decimals: 0,
                                min: 0,
                                step:1
                            });
                }
            },
            {
                field: "securityLevel",
                title: "保障级别",
                width: 120,
                 editor: function(container, options){
                	 //保障级别
                     $.ajax({
                           type:"POST",
                           async:false,
                           url:"${base.contextPath}/fms/pln/plan/library/querySecurityLevelByItem",
                           data:{"itemId":options.model.itemId},
                           dataType : 'json',
                           success: function(e) {
                               $('<input name="' + options.field + '" data-bind="value:securityLevel" />')
                                   .appendTo(container)
                                   .kendoDropDownList({
                                       dataTextField: "meaning",
                                       dataValueField: "value",
                                       dataSource: e.rows,
                                       optionLabel:"--请选择--",
                                       change : function(e) {
                                       }
                                   });
                           }
                       });
                	 
                     if(options.model.minClass != 'GD'){
                      	$("input[name='securityLevel']").data("kendoDropDownList").enable(false);
                      }
                 } 
            },
            {
                field: "securityArea",
                title: "保障区域",
                width: 120,
                editor: function(container, options){
                	
                	//保障区域
                    $.ajax({
                          type:"POST",
                          async:false,
                          url:"${base.contextPath}/fms/pln/plan/library/querySecurityAreaByItem",
                          data:{"itemId":options.model.itemId},
                          dataType : 'json',
                          success: function(e) {
                              $('<input name="' + options.field + '" data-bind="value:securityArea" />')
                                  .appendTo(container)
                                  .kendoDropDownList({
                                      dataTextField: "meaning",
                                      dataValueField: "value",
                                      dataSource: e.rows,
                                      optionLabel:"--请选择--",
                                      change : function(e) {
                                      }
                                  });
                          }
                      });
                	
                     if(options.model.minClass != 'GD'){
                     	$("input[name='securityArea']").data("kendoDropDownList").enable(false);
                     	
                     }
                 } 
            },
            {
                field: "selfpay",
                title: "自付选项",
                width: 120,
                editor: function (container, options) {
                    $('<input  name="' + options.field + '"/>')
                            .appendTo(container)
                            .kendoLov($.extend(<@lov "PRD_ITEM_SELFPAY"/>, 
                           {
                                textField: 'selfpay',
                                model    : options.model,
                                select:function(e){
				                	options.model.set('selfpay', e.item.selfpay);
				                	options.model.set('selfpayId', e.item.selfpayId);
				                }
                            },
                            {
                            	query: function (e) {
                                   e.param['itemId'] = options.model.itemId;
                                 }
                            }));
                    if(options.model.minClass != 'GD'){
                    	$("input[name='selfpay']").data("kendoLov").enable(false);
                    }
                }
            },
            {
                title: '<@spring.message "hap.action"/>',
                width: 80,
                headerAttributes: {
                    'class':'table-header-cell',
                    style:'text-align: center;vertical-align:middle;'
                },
                attributes: {
                    "class": "table-cell",
                    style: "text-align:center;"
                },
                template : function (dataItem) {
                    var buttons = '';
                    if(dataItem.fileId != '' && dataItem.fileId != undefined){
                        buttons = '&nbsp;<button type="button" class="btn btn-info btn-xs" data-toggle="tooltip" data-placement="top" id="attacheDownload'+dataItem.uid+'" onclick="downloadFile(\''+dataItem.uid+'\')" title="<@spring.message "hap.download"/>"><span class="fa fa-download"></span></button>';
                    }
                    else buttons = '&nbsp;<button type="button" class="btn btn-info btn-xs" data-toggle="tooltip" data-placement="top" id="attacheDownload'+dataItem.uid+'" onclick="downloadFile(\''+dataItem.uid+'\')"  disabled="disabled" title="<@spring.message "hap.download"/>"><span class="fa fa-download"></span></button>';

                    return  '<button type="button" class="btn btn-info btn-xs" data-toggle="tooltip" data-placement="top" id="attacheUpload'+dataItem.uid+'" onclick="upload(\''+dataItem.uid+'\')" title="<@spring.message "sysfile.upload"/>"><span class="fa fa-upload"></span></button>'+buttons;
                }
            }
            
        ],
        editable: true
    });

    Hap.autoResizeGrid("#grid");
})    
</script>

<div class="content-container">
		<div id="page-content">
		    <div class="panel">
            <form class="form-horizontal" id="myForm">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-3">
                             <div class="form-group">
                                <label class="col-sm-3 control-label">产品名称</label>
                                <div class="col-sm-9">
                                     <input type="text" style="width:100%;" id="itemCode"
										data-bind="value:model.itemCode"></input>
                                </div>
                            </div>
                            <script>
                                        $("#itemCode").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "PRD_ITEMS")}, {
                                        	select:function(e){
                                        		viewModel.model.set('itemCode', e.item.itemCode);
                                        		viewModel.model.set('itemName', e.item.itemName);
                                        		viewModel.model.set('itemId', e.item.itemId);
                                        		viewModel.model.set('sublineItemName', null);
                                        		$("#securityArea").data("kendoDropDownList").setDataSource(null);
                                        		$("#securityLevel").data("kendoDropDownList").setDataSource(null);
                                        		$("#payMethod").data("kendoDropDownList").setDataSource(null);
                                        		//保障区域
                                        		$.ajax({
                                        		      type:"POST",
                                        		      async:false,
                                        		      url:"${base.contextPath}/fms/pln/plan/library/querySecurityAreaByItem",
                                        		      data:{"itemId":e.item.itemId},
                                        		      dataType : 'json',
                                        		      success: function(e) {
                                        		    	  $("#securityArea").data("kendoDropDownList").setDataSource(e.rows);
                                        		      }
                                        		 });
                                        		 
                                        		//保障级别
                                        		$.ajax({
                                        		      type:"POST",
                                        		      async:false,
                                        		      url:"${base.contextPath}/fms/pln/plan/library/querySecurityLevelByItem",
                                        		      data:{"itemId":e.item.itemId},
                                        		      dataType : 'json',
                                        		      success: function(e) {
                                        		    	  $("#securityLevel").data("kendoDropDownList").setDataSource(e.rows);
                                        		      }
                                        		  });
                                        		
                                        		//缴费方式
                                        		$.ajax({
                                        		      type:"POST",
                                        		      async:false,
                                        		      url:"${base.contextPath}/fms/pln/plan/library/queryPaymethodByItem",
                                        		      data:{"itemId":e.item.itemId},
                                        		      dataType : 'json',
                                        		      success: function(e) {
                                        		    	  $("#payMethod").data("kendoDropDownList").setDataSource(e.rows);
                                        		      }
                                        		  });
            				                }
                                        }))
			                </script>
                        </div>
                    
                         <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">年期</label>
                                <div class="col-sm-9">
                                    <input type="text" style="width:100%;"
										data-bind="value:model.sublineItemName" id="sublineItemName"></input>
									<script>
                                        $("#sublineItemName").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "ORD_SUBLINE")}, {
                                        	query: function (e) {
             			                       e.param['itemId'] = viewModel.model.itemId;
             			                     },
                                        	select:function(e){
                                        		viewModel.model.set('sublineItemName', e.item.sublineItemName);
            				                }
                                        }))
			                        </script>	
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">性别</label>
                                <div class="col-sm-9">
                                    <select data-role="combobox" data-value-primitive="true" style="width:100%;"
										data-text-field="meaning" data-value-field="value"
										data-bind="source: genderCom, value: model.gender"></select>       
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">年龄范围</label>
                                <div class="col-sm-9">
                                    <select data-role="combobox" data-value-primitive="true" style="width:100%;"
										data-text-field="meaning" data-value-field="value"
										data-bind="source: ageCom, value: model.age"></select>         
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">是否吸烟</label>
                                <div class="col-sm-9">
                                    <select data-role="combobox" data-value-primitive="true" style="width:100%;"
										data-text-field="meaning" data-value-field="value"
										data-bind="source: flagCom, value: model.smokeFlag"></select>         
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">缴费方式</label>
                                <div class="col-sm-9">
                                    <input type="text" data-value-primitive="true" style="width:100%;"
										data-text-field="meaning" data-value-field="value" id="payMethod"
										data-bind="value: model.payMethod">         
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-3">
<!--                             <div class="form-group"> -->
<!--                                 <label class="col-sm-3 control-label">保障级别</label> -->
<!--                                 <div class="col-sm-9"> -->
<!--                                     <select data-role="combobox" data-value-primitive="true" style="width:100%;" -->
<!-- 										data-text-field="meaning" data-value-field="value" -->
<!-- 										data-bind="source: securityLevel, value: model.securityLevel" id="securityLevel"></select>            -->
<!--                                 </div> -->
<!--                             </div> -->
                            
                             <div class="form-group">
                                <label class="col-sm-3 control-label">保障级别</label>
                                <div class="col-sm-9">
                                   <input type="text" style="width: 100%"
                                           data-text-field="meaning" data-value-field="value" data-value-primitive="true"
                                           data-bind="value:model.securityLevel" id="securityLevel" >
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
<!--                             <div class="form-group"> -->
<!--                                 <label class="col-sm-3 control-label">保障地区</label> -->
<!--                                 <div class="col-sm-9"> -->
<!--                                     <select data-role="combobox" data-value-primitive="true" style="width:100%;" -->
<!-- 										data-text-field="meaning" data-value-field="value" id="securityArea" -->
<!-- 										data-bind="source: securityArea, value: model.securityArea"></select>           -->
<!--                                 </div> -->
<!--                             </div> -->
                            <div class="form-group">
                                <label class="col-sm-3 control-label">保障地区</label>
                                <div class="col-sm-9">
                                   <input type="text" style="width: 100%"
                                           data-text-field="meaning" data-value-field="value" data-value-primitive="true"
                                           data-bind="value:model.securityArea" id="securityArea" >
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">自付选项</label>
                                <div class="col-sm-9">
                                    <input type="text" style="width: 100%" id=selfpay
                                           data-bind="value:model.selfpay">
                                    <script>
                                        $("#selfpay").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "PRD_ITEM_SELFPAY")}, {
                                        	  query: function (e) {
                                                e.param['itemId'] = viewModel.model.itemId;
                                              }
                                        }))
			                        </script>       
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">居住国</label>
                                <div class="col-sm-9">
                                    <select data-role="combobox" data-value-primitive="true" style="width:100%;"
										data-text-field="meaning" data-value-field="value"
										data-bind="source: nationalityCom, value: model.residence"></select>          
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">居住城市</label>
                                <div class="col-sm-9">
                                    <select data-role="combobox" data-value-primitive="true" style="width:100%;"
										data-text-field="meaning" data-value-field="value"
										data-bind="source: cityCom, value: model.city"></select>             
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">国籍</label>
                                <div class="col-sm-9">
                                    <select data-role="combobox" data-value-primitive="true" style="width:100%;"
										data-text-field="meaning" data-value-field="value"
										data-bind="source: nationalityCom, value: model.nationality"></select>        
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">保费</label>
                                <div class="col-sm-9">
                                      <input type="text" style="width: 45%" data-bind="value:model.premiumStart" id="premiumStart">-
                                      <input type="text" style="width: 50%" data-bind="value:model.premiumEnd" id="premiumEnd"> 
                                      <script>
                                         $("#premiumStart").kendoNumericTextBox({
                                            min: 0,
                                            step: 1
                                         });
                                         $("#premiumEnd").kendoNumericTextBox({
                                             min: 0,
                                             step: 1
                                          });
                                      </script>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">保额</label>
                                <div class="col-sm-9">
                                      <input type="text" style="width: 45%" data-bind="value:model.amountStart" id="amountStart">-
                                      <input type="text" style="width: 50%" data-bind="value:model.amountEnd" id="amountEnd"> 
                                      <script>
                                         $("#amountStart").kendoNumericTextBox({
                                            min: 0,
                                            step: 1
                                         });
                                         $("#amountEnd").kendoNumericTextBox({
                                             min: 0,
                                             step: 1
                                          });
                                      </script>
                                </div>
                            </div>
                        </div>
                    </div><!-- row end -->
                    </div><!-- panel-body end -->
                          <div class="panel-footer text-right">
                            <span class="btn btn-primary" data-bind="click:queryFunction" type="submit">
                                <i class="fa fa-search"
                                   style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
                            <span class="btn btn-default" type="button" data-bind="click:resetForm">
                                <i class="fa fa-eraser"
                                   style="margin-right:3px;"></i><@spring.message "hap.reset"/></span>
                        </div>
                
            </form>
        </div>
	    <div>
				<div id="grid" class="table"></div>
				<iframe id="ifileCompany" style="display:none"></iframe>
				<div id="fileWin" style="display: none;">
                     <input type="file" id="files" name="files"></input>
                </div>
                <iframe id="ifile" style="display:none"></iframe>
		</div>
		</div>
</div>
<script type="text/javascript">
kendo.bind($('#page-content'), viewModel);

$("#files").kendoUpload({
    async        : {
        saveUrl: "${base.contextPath}/commons/attach/upload?${_csrf.parameterName}=${_csrf.token}"
    },
    showFileList : false,
    upload       : onUpload,
    success      : onSuccess
});

function onUpload(e){

    e.data = {
        modularName:'PRD',
        allowType:'jpg;png;pdf;doc;xls;xlsx;docx',
        maxSize:20480
    }

};
var fileId;
var fileIds = [];
function onSuccess(e){
    if(e.response.success){
        var grid = $("#grid").data("kendoGrid");
        var data = grid.dataSource.getByUid(uidData);
        data.fileSize = Math.ceil(e.response.file.fileSize);
        data.oldFileId = data.fileId;
        data.fileId = e.response.file.fileId;
        data.fileName = e.response.file.fileName;
        data._token = e.response.file._token;
        var newTime = new Date(e.response.file.uploadDate);
        newTime = Hap.formatDateTime(newTime);
        data.uploadDate = newTime;
        data.dirty = true;
        grid.refresh();
        document.getElementById("attacheDownload"+uidData).disabled="";
        fileWin.close();
        fileId = data.fileId;
        fileIds.push(fileId);
        kendo.ui.showInfoDialog({
            message: '上传成功,请点击保存按钮!'
        })
    }else{
        kendo.ui.showErrorDialog({
            message  : e.response.message
        })
    }
}

//上传文件
var uidData;
var isUpload;
function upload(uid){
    uidData = uid;
    data = $('#grid').data('kendoGrid').dataSource.getByUid(uidData);
    if(data.fileId != "" && typeof(data.fileId) != "undefined"){
        kendo.ui.showConfirmDialog({
            message: '<@spring.message "fms.overwrite_file"/>'
        }).done(function (e) {
            if (e.button == 'OK') {
                isUpload = true;
                window.fileWin = $("#fileWin").kendoWindow({
                    title: '<@spring.message "sysfile.upload"/>',
                    width: 400,
                    height: 250,
                    modal: true
                }).data("kendoWindow");
                fileWin.center().open();
            }else{
                isUpload = false;
            }
        });
    }
    else{
        isUpload = false;
        window.fileWin = $("#fileWin").kendoWindow({
            title: '<@spring.message "sysfile.upload"/>',
            width: 400,
            height: 250,
            modal: true
        }).data("kendoWindow");
        fileWin.center().open();
    }
}	 

//维护文件下载
function downloadFile(uid)
{
    data =  $('#grid').data('kendoGrid').dataSource.getByUid(uid);
    $.ajax({
        url : '${base.contextPath}/commons/attach/validateFile',
        type : "POST",
        dataType : "json",
        data : {
            fileId:data.fileId,
            token:data._token
        },
        success : function(json) {
            if(json.success == true){
                url='${base.contextPath}/fms/sys/attach/file/detail?fileId='+data.fileId+'&token='+data._token;
                var iframe = document.getElementById("ifile");
                iframe.src=url;
            }
            else{
                kendo.ui.showErrorDialog({
                    message  : '<@spring.message "fms.file_not_exists"/>'
                })
            }
        },
    })

};

//保障区域 
$("#securityArea").kendoDropDownList({
    dataTextField: "meaning",
    dataValueField: "value",
    optionLabel:'--保障区域--',
    dataSource: []
});

//保障级别
$("#securityLevel").kendoDropDownList({
    dataTextField: "meaning",
    dataValueField: "value",
    optionLabel:'--保障级别--',
    dataSource: []
})
//保障级别
$("#payMethod").kendoDropDownList({
    dataTextField: "meaning",
    dataValueField: "value",
    optionLabel:'--缴费方式--',
    dataSource: []
})
</script>
</body>
</html>