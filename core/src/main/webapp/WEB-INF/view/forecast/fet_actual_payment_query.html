<#-- 
 * description:实付汇总页面
 * version: 1.0 
 * author:bo.wu@hand-china.com
 * -->
<#include "../include/header.html">
<script src="${base.contextPath}/clb/common/clbCode?paymentType=FET.PAYMENT_TYPE" type="text/javascript"></script>
<script src="${base.contextPath}/clb/common/clbCode?currencyType=PUB.CURRENCY" type="text/javascript"></script>
<script src="${base.contextPath}/clb/common/clbCode?paymentCompanyTypes=SPE.PAYMENT_COMPANY_TYPE" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="${base.contextPath}/resources/js/common/zeroModal/zeroModal.css" />
<script src="${base.contextPath}/resources/js/common/zeroModal/zeroModal.js" type="text/javascript"></script>
<script src="${base.contextPath}/resources/js/common/number.js" type="text/javascript"></script>
<style>
	.k-upload-selected{
		margin-left: .8em;
		margin-top: .8em;
        margin-right:.2em;
	}

</style>
<script type="text/javascript">
    var viewModel = kendo.observable({
        model: {},
        queryResource: function (e) {
            $('#Grid').data('kendoGrid').dataSource.page(1);
        },
        resetForm: function (e) {
        	$(" input[ type='text' ] ").val();
            var formData = viewModel.model.toJSON();
            for (k in formData) {
                viewModel.model.set(k, null);
            }
        }
    });
    window.response = {};
</script>
<body>
<div id="dialog" style="display: none;"></div>
<div id="resultdialog" style="display: none;"></div>
<div id="fileWin" style="display: none;">
	<form>
	<input type="file" id="certificateFileId" name="certificateFileIds"></input>
	</form>
</div>
<div id="importWin" style="display: none;">
	<form>
         <input type="file" name="files" id="importExcelFile">
    </form>
</div>
<div id="page-content">
<div class="panel">
    <form class="form-horizontal">
    		<div class="panel-body">
			<div class="row" style="margin-bottom: 10px;">
						<div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label"><@spring.message "fet.actual.payment.paymentperiod"/></label>
                                <div class="col-sm-9">
                                    <input style="float:left;width:150px;margin-right:5px;"
				                   	id="paymentPeriod" data-bind="value:model.paymentPeriod">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label"><@spring.message "fet.actual.payment.paymentSupplierName"/></label>
                                <div class="col-sm-9">
                                    <input type="text" data-role="maskedtextbox" style="float:left;width:150px;margin-right:5px;" placeholder='<@spring.message "fet.actual.payment.paymentSupplierName"/>'
                   						data-bind="value:model.paymentSupplierName" class="k-textbox">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label"><@spring.message "fet.actual.payment.receiveCompanyName"/></label>
                                <div class="col-sm-9">
                                    <input type="text" data-role="maskedtextbox" style="float:left;width:150px;margin-right:5px;" placeholder='<@spring.message "fet.actual.payment.receiveCompanyName"/>'
                   						data-bind="value:model.receiveCompanyName" class="k-textbox">
                                </div>
                            </div>
                        </div>
              </div>
              </div>
              <div class="panel-footer text-right">
               		<span class="btn btn-success" data-bind="click:queryResource" type="submit"><i class="fa fa-search" style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
               		<span class="btn btn-success" data-bind="click:resetForm" type="button"><i class="fa fa-eraser" style="margin-right:3px;"></i><@spring.message "hap.reset"/></span>
                </div>
                <iframe id="ifile" style="display:none"></iframe>
		</form>
	</div>
    <script>kendo.bind($('#page-content'), viewModel);</script>
    <div style="clear:both">
        <div id="Grid"></div>
    </div>
</div>

<script type="text/x-kendo-template" id="template">
  	<div id="toolbar-btn" style="padding-bottom:10px;">
        <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;"><i class="fa fa-plus-square" style="margin-right:3px;"></i><@spring.message "hap.new"/></span>
        <span class="btn btn-success k-grid-save-changes" style="float:left;margin-right:5px;"><i class="fa fa-save" style="margin-right:3px;"></i><@spring.message "hap.save"/></span>
		<span class="btn btn-default k-grid-cancel-changes" style="float:left;margin-right:5px;"><i class="fa fa-eraser" style="margin-right:3px;"></i><@spring.message "hap.cancel"/></span>

		<span class="btn btn-primary" style="float:right;margin-right:5px;"  onclick="downloadModelFile()"><i class="fa fa-download" style="margin-right:3px;"></i><@spring.message "hap.downloadmodel"/></span>
		<span class="btn btn-primary" style="float:right;margin-right:5px;"  onclick="importData()"><i class="fa fa-upload" style="margin-right:3px;"></i><@spring.message "hap.batchimport"/></span>
   </div>
</script>

<script type="text/javascript">

	$(function(){
	    var rownumList = $('[data-index="0"]');
	    for (var i=0;i<rownumList.length;i++)
	    {
	        var rownumText = $(rownumList[i]).html();
	        if("#"==rownumText){
	            $(rownumList[i]).html("<@spring.message "spe.rownum"/>");
	            $(rownumList[i]).eq(0).parent().parent().prev().children().eq(0).css("width","50px");
	            $(rownumList[i]).eq(0).parent().parent().parent().parent().parent().next().children("table").children("colgroup").children().eq(0).css("width","50px");
	        }
	    }
	});
	

	//付款类型
	$("#paymentPeriod")
	.kendoDropDownList({
		open:function(){
	    	var dropdownlist = $("#paymentPeriod").data("kendoDropDownList");
	    	dropdownlist.dataSource.read();
	    },
			dataSource  : {
			transport: {
	            read: {
	            	type:"POST",
	                dataType: "json",
	                url: '${base.contextPath}/fet/actual/payment/summary/getAll'
	            }
	        },
	        schema: {
	        	data:'rows'
	        }
		}
	});

    var BaseUrl = _basePath+"/fet/actual/payment/summary";
    dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/query",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/submit",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "paymentSummaryId",
                fields: {
                	paymentPeriod:{validation:{required:true}},
                	receiveCompanyType:{validation:{required:true}},
                	receiveCompanyId:{validation:{required:true}},
                	paymentSupplierId:{validation:{required:true}},
                	version:{defaultValue:1},
                	hkdAmount:{defaultValue:0}
                },
                editable:function(col){
                	if(col=="hkdAmount"){
                		return false;
                	}
                	return true;
                }
            }
        }
    });

     $("#Grid").kendoGrid({
        dataSource: dataSource,
        height: '100%',
        resizable: true,
        scrollable: true,
        navigatable: false,
        rownumber: true,
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            {
                field: "paymentSupplierId",
                title: '<@spring.message "fet.actual.payment.paymentSupplierId"/>',
                width: 120,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                template:function(dataItem){
                    return dataItem['paymentSupplierName']||'';
                },
                editor: function (container, options) {
                    $('<input id="girdPaymentSupplierId" required validationMessage="必输" name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoLov($.extend(<@lov "SPE_SUPPLIER_NAME"/>, {
                       	change:function(e){
                       		var lov = $("#girdPaymentSupplierId").data('kendoLov');
                        	if(lov.text() == ''){
                        		options.model.paymentSupplierId = null;
                        	}
                         	options.model.set('paymentPeriod',null);
                        },
                        textField:'paymentSupplierName',
                        model: options.model
                    }));

                }
            },
            {
                field: "paymentPeriod",
                title: '<@spring.message "fet.actual.payment.paymentperiod"/>',
                width: 120,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                editor: function (container, options) {
                    $('<input id="gridPaymentPeriod" required validationMessage="必输" name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoLov($.extend(<@lov "FET_PERIOD"/>, {
                        model: options.model,
                        query:function(e){
                        	e.param['partyType'] = 'SUPPLIER';
                        	e.param['partyId'] = options.model.paymentSupplierId;
                        },
                        select:function(e){
                        	options.model.set('paymentPeriod',e.item.periodName);
                        }
                    }));
                    if(options.model.paymentSupplierId　== null ||options.model.paymentSupplierId　== ''){
                        var gridPaymentPeriodLov = $("#gridPaymentPeriod").data("kendoLov");
                        console.log(gridPaymentPeriodLov)
                        gridPaymentPeriodLov.enable(false)
                    };
           		}
            },
            {
                field: "receiveCompanyType",
                title: '<@spring.message "fet.actual.payment.receiveCompanyType"/>',
                width: 120,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                template: function(dataItem){
			        var v = dataItem.receiveCompanyType;
			        $.each(paymentCompanyTypes,function(i,n){
			            if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
			                v = n.meaning;
			                return v;
			            }
			        })
			        if(v != undefined) return v;
			        return '';
			     },
                editor: function (container, options) {
                	$('<input required validationMessage="必输" id="gridPaymentCompanyType" name="' + options.field + '"/>')
			         .appendTo(container)
			         .kendoDropDownList({
			        	 change:function(){
			        		 options.model.set('receiveCompanyId',null);
							 editCell(options.model.uid,4);
							 var lov = $("#gridReceiveCompanyId").data('kendoLov');
							 lov.text('');
			        	},
						dataSource :paymentCompanyTypes,
						valuePrimitive: true,
			   			dataTextField: "meaning",
			   			dataValueField: "value"
						});
                    if(options.model.paymentSupplierId　== null ||options.model.paymentSupplierId　== ''){
                        var dropdownlist = $("#gridPaymentCompanyType").data("kendoDropDownList");
                        dropdownlist.enable(false);
                    }
           		}
            },{
                field: "receiveCompanyId",
                title: '<@spring.message "fet.actual.payment.receiveCompanyId"/>',
                width: 140,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center;vertical-align:middle"
                },
                template: function (dataItem) {
                    return dataItem['receiveCompanyName'] || ''
                },
                editor: function (container, options) {
                	if(options.model.receiveCompanyType == 'CHANNEL'){
                		$('<input id="gridReceiveCompanyId" required validationMessage="必输" name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoLov($.extend(<@lov "SPE_PAYMENT_TERM_CHANNEL"/>, {
                        	textField:'receiveCompanyName',
                            model: options.model,
                            select:function(e){
                            	options.model.set('receiveCompanyName',e.item.channelName);
                            }
                        }));
                	}else{
                		$('<input id="gridReceiveCompanyId" required validationMessage="必输" name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoLov($.extend(<@lov "SPE_PAYMENT_TERM_SUPPLIER"/>, {
                        	textField:'receiveCompanyName',
                            model: options.model,
                            select:function(e){
                            	options.model.set('receiveCompanyName',e.item.name);
                            }
                        }));
                        if(options.model.paymentSupplierId　== null ||options.model.paymentSupplierId　== ''){
                            var gridReceiveCompanyIdLov = $("#gridReceiveCompanyId").data("kendoLov");
                            gridReceiveCompanyIdLov.enable(false);
                        };
                	}
               	}
            },{
                field: "version",
                title: '<@spring.message "fet.actual.payment.version"/>',
                width: 120,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                editor: function (container, options) {
                    $('<input required data-required-msg="必输" name="' + options.field + '"/>')
                       .appendTo(container)
                       .kendoNumericTextBox({
                           min: 1,
                           step: 1
                       }).data("kendoNumericTextBox");
               	}
            }, {
                field: "hkdAmount",
                title: '<@spring.message "fet.actual.payment.summaryHkdAmount"/>',
                width: 120,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                template:function (dataItem) {
                	if(dataItem.hkdAmount == undefined) return "";
                    return dataItem.hkdAmount.toFixed(2);
                }
            },		{
                title: "<@spring.message "hap.action"/>",
                width: 80,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                template:function(dataItem){
                	return '<a href="javascript:void(0)" onclick="editData(\''+dataItem.uid+'\')" style="width:50px">查看详情</a>';
                }
            } ,{
                title: "<@spring.message "fet.actual.payment.payticket"/>",
                width: 120,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                template:function(dataItem){
                	var html = '<a href="javascript:void(0)" onclick="upload(\''+dataItem.uid+'\')" style="width:50px">上传凭证</a>';
                	if(dataItem.certificateFileId != null && dataItem.certificateFileId !='' && dataItem.certificateFileId != undefined){
                		html = html+'&nbsp <a href="javascript:void(0)" onclick="downloadFile(\''+dataItem.uid+'\')" style="width:50px">下载凭证</a>';
                	}
                	return html;
                }
            } 
        ],
        toolbar: kendo.template($("#template").html()),
        editable: true
    }).data('kendoGrid');
    Hap.autoResizeGrid("#Grid");
    
    function addRow(){
    	grid.addRow();
    }
    
    function saveChanges(){
    	grid.saveChanges();
    }
    
    //编辑某列的值
    function editCell(uid,index){
    	var grid = $("#Grid").data("kendoGrid");
       	var dataRows = grid.items().prevObject.prevObject[0];
       	var trList=dataRows.getElementsByTagName("tr");
       	var currentNode = "";
       	//获取当前节点
       	for(var temp=0;temp<trList.length;temp++){
      		if(uid == trList[temp].dataset.uid){
      			currentNode = trList[temp];
      		}
          }
       	grid.editCell(currentNode.childNodes[index]);
    }
    
  	//新建和编辑时调用的界面
    window.editData = function(uid){
	  		var data = dataSource.getByUid(uid);
	  		var paymentPeriod = data.paymentPeriod;
	  		var receiveCompanyType = data.receiveCompanyType;
	  		var receiveCompanyName = data.receiveCompanyName;
	  		var paymentSupplierName = data.paymentSupplierName;
	  		var receiveCompanyId = data.receiveCompanyId;
	  		var paymentSupplierId = data.paymentSupplierId;
	  		var paymentSummaryId = data.paymentSummaryId;
	  		var version = data.version;
	  		if(paymentSummaryId == '' || paymentSummaryId == undefined || paymentSummaryId == null){
	  			kendo.ui.showInfoDialog({
	                title    : '提示',
	                message  : '请先保存数据!'
	            })
	            return;
	  		}
	  		var id = "actualpayment"+paymentPeriod.replace(new RegExp(/((\/)|-)/g),'')+receiveCompanyId+paymentSupplierId+version+"view";
    		closeTab(id);
    		var url="forecast/fet_actual_payment_detail.html?paymentPeriod="+paymentPeriod+"&paymentSummaryId="+paymentSummaryId+"&paymentSupplierName="+paymentSupplierName+"&receiveCompanyName="+receiveCompanyName;
			window.top.openTab(id,"实付_"+paymentPeriod+"_"+paymentSupplierName+"_"+receiveCompanyName+"_"+"版本"+version+"明细",url);
    };
    
    //关闭tab页
    function closeTab(id){
    	var parent = window.parent.parent.$("#mainTab");
    	var mainTab = parent.data("kendoTabStrip");
        var idx = jQuery.inArray(id,mainTab.tabids),
        activeIndex = mainTab.tabGroup.children('li.k-state-active').index();
        if(idx == -1) return;
        mainTab.remove(idx);
        if (activeIndex == idx ) {
            if (mainTab.tabids.length >= idx + 1) mainTab.select(idx)
            else if (idx - 1 >= 0) mainTab.select(idx - 1);
        }
    };
    
    
    function importData(){
    	window.fileWin = $("#importWin").kendoWindow({
            title: '批量导入',
            width: 400,
            height: 250,
            modal: true
        }).data("kendoWindow");
        fileWin.center().open();
    }
    
    $("#importExcelFile").kendoUpload({
 	    async:{
 	        saveUrl: "${base.contextPath}/fet/actual/payment/summary/loadExcel?${_csrf.parameterName}=${_csrf.token}"
 	    },
 	    validate:function(e){
	    	if(e.files[0].validationErrors != undefined && e.files[0].validationErrors.length != 0){
	    		kendo.ui.showErrorDialog({
	                title    : '导入失败',
	                message  : '只允许导入xls,xlsx类型!'
	            })
	    	}
	    },
	    localization: {
	        select: "批量导入",
	        headerStatusUploading: "上传中...",
	        headerStatusUploaded: "文件上传完成"
	    },
 	   validation: {
           allowedExtensions: ['xls','xlsx']
       },
	   multiple: false,
	   showFileList: false,
       success:function (e) {
	    	if(e.response.success){
    			 window.response = e.response;
    			 var url = '${base.contextPath}/common/excelimportresult.html';
 	             var dialog =  $("#resultdialog").kendoWindow({
   		            width: 700,
   		            height: 700,
   		            title: '导入结果', 
   		            content: url,                  
   		            iframe:  true,
   		            visible: false,
   		            modal:true,
   		            close:function(){
   		            	$("#Grid").data("kendoGrid").dataSource.read();
   		            }
   		         }).data("kendoWindow");
   		         dialog.maximize();
   				 dialog.open();
				fileWin.close();
	        }else{
	             kendo.ui.showErrorDialog({
	                 title: '导入失败',
	                 message: e.response.message
	             });

	        }
	    }
 	});
    
    var uidData;
    function upload(uid){
		uidData = uid;
		data = dataSource.getByUid(uidData);
		if(data.certificateFileId != "" && data.certificateFileId != undefined){
			kendo.ui.showConfirmDialog({
        		title:'确认框',
                message:'<@spring.message "spe.recoverfile"/>',
            }).done(function (e) {
            	if (e.button == 'OK') {
            		window.fileWin = $("#fileWin").kendoWindow({
                        title: '<@spring.message "sysfile.upload"/>',
                        width: 400,
                        height: 250,
                        modal: true
                    }).data("kendoWindow");
                    fileWin.center().open();
            	}
	        });
		}
		else{
			window.fileWin = $("#fileWin").kendoWindow({
                title: '<@spring.message "sysfile.upload"/>',
                width: 400,
                height: 250,
                modal: true
            }).data("kendoWindow");
            fileWin.center().open();
		}
		
	}
	$("#certificateFileId").kendoUpload({
	    async        : {
	        saveUrl: "${base.contextPath}/commons/attach/upload?${_csrf.parameterName}=${_csrf.token}"
	    },
	    validate:function(e){
	    	if(e.files[0].validationErrors != undefined && e.files[0].validationErrors.length != 0){
	    		kendo.ui.showErrorDialog({
	                title    : '上传失败',
	                message  : '只允许上传jpg,png,pdf类型!'
	            })
	    	}
	    },
	    multiple: false,
 	    localization: {
 	        select: "上传文件",
 	        headerStatusUploading: "上传中...",
 	        headerStatusUploaded: "文件上传完成"
 	    },
 	   validation: {
           allowedExtensions: ['jpg','png','pdf']
       },
       showFileList: false,
	    upload       : onUpload,
	    success      : onSuccess
	});
	
    function onUpload(e){
    		e.data = {
    				modularName:'FET',
    				maxSize:51200
    	    }
    };
	function onSuccess(e){
		if(e.response.success){
            var data = dataSource.getByUid(uidData);
            if(data.certificateFileId != "" && data.certificateFileId != undefined){
				data.oldFileId = data.certificateFileId;
            }
            data.certificateFileId = e.response.file.fileId;
            data.fileToken = e.response.file._token;
            data.dirty = true;
            /* if(data.receiptSummaryId != null)grid.saveChanges(); */
    		fileWin.close();
    		kendo.ui.showInfoDialog({
                title    : '成功',
                message  : '<@spring.message "spe.pleasesavedata"/>'
            })
		}else{
			kendo.ui.showErrorDialog({
                title    : '错误',
                message  : e.response.message
            })
		}
	}
	
	function downloadModelFile(){
		url='${base.contextPath}/commons/excelmodel/export?dtoName=clb.core.forecast.dto.FetActualPaymentSummary&fileName=实付导入模板';
	   	var iframe = document.getElementById("ifile");
	   	iframe.src=url;
	}
	
	//下载文件
	function downloadFile(uid) 
		{ 
		var data = dataSource.getByUid(uid);
		$.ajax({
			 url : '${base.contextPath}/commons/attach/validateFile',
             type : "POST",
             dataType : "json",
             data : {
            	 fileId:data.certificateFileId,
                 token:data.fileToken
             },
             success : function(json) {
                    if(json.success == true){
                    	url='${base.contextPath}/fms/sys/attach/file/detail?fileId='+data.certificateFileId+'&token='+data.fileToken;
               	   		var iframe = document.getElementById("ifile");
               	   		iframe.src=url;
                    }else{
                    	if(json.message != "" && json.message != undefined && json.message != null){
                    		kendo.ui.showErrorDialog({
                                title    : '错误',
                                message  : json.message
                            })
                    	}else{
                    		kendo.ui.showErrorDialog({
                                title    : '错误',
                                message  : '<@spring.message "fms.file_not_exists"/>'
                            })
                    	}
                    	
                    }
             },
		})
			
		};
</script>
</body>
</html>